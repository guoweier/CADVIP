---
title: "lmer_QTL"
author: "Weier Guo"
date: '2022-08-29'
output: html_document
---

### Introduction ###
A Notebook to run QTL with only P.deltoides and P.nigra. The effect of dosage variation should be embedded into P.nigra before the model establishment. 

Model:
**Phenotype ~ intercept + dosage_genotype + P.deltoides_genotype + P.nigra_genotype**
It can be started with: 
**Y ~ beta0 + beta1*gtDeltoides + beta2*gtNigra + e**
**gtDeltoides: (-1,1)**
**gtNigra: (-1,1,0,-2,2...) represents (allele1 normal, allele2 normal, deletion, allele1 duplication, allele2 duplication, ...)**


### load library and data ###
library
```{r}
library(tidyverse)
library(qqman)
library(ggplot2)
```

dataset
```{r}
# genotypes
nigra_gt <- read_tsv("../output/Pnigra_genome_marker_20220825.txt")
deltoides_gt <- read_tsv("../output/Pdeltoides_nigraMarker_20220825.txt")
dosage_gt <- read_tsv("../output/Dosage_nigraMarker_20220825.txt")
nigra_gt
deltoides_gt
dosage_gt
```

```{r}
# phenotypes
biomass <- read_tsv("../../Kmer/input/pheno_output_table_blup_20220428.txt")
leaf <- read_tsv("../../Kmer/input/pheno_leaf_20220527.txt")
vessel <- read_csv("../../Kmer/input/pheno_vessel_20220522.csv")
biomass
leaf
vessel
```


```{r}
leaf.list <- read_csv("../input/Leaf_pheno_20220824.csv")
leaf.list
```

```{r}
leaf.new <- tibble(leaf$Old.Name)
for (i in 1:length(leaf.list$V1)) {
  pheno.name <- leaf.list$V1[i]
  indice <- which(colnames(leaf) == pheno.name)
  leaf.new <- cbind(leaf.new, leaf[,indice])
}
colnames(leaf.new)[1] <- "Old.Name"
leaf.new
```


### dataset preparation ###
#### Embed dosage variation into P.nigra genotype ####
1. Transfer dosage genotype into matrix
```{r}
dosage_gt_matrix <- as.matrix(dosage_gt)
del_seg <- which(dosage_gt_matrix == "0",arr.ind = TRUE)
dup_seg <- which(dosage_gt_matrix == "2",arr.ind = TRUE)
```

2. Transfer Pnigra genotype into matrix, prepare for replacement
```{r}
nigra_gt_matrix <- as.matrix(nigra_gt)
```

3. Based on del_seg, replace NAs in nigra_gt_matrix into 0
```{r}
for (i in 1:nrow(del_seg)) {
  row <- del_seg[i,1]
  col <- del_seg[i,2]
  nigra_gt_matrix[row,col] <- "0"
}
```

4. Based on dup_seg, replace alleles in nigra_gt_matrix into -2 or 2 or keep in NAs. 
```{r}
for (i in 1:nrow(dup_seg)) {
  row <- dup_seg[i,1]
  col <- dup_seg[i,2]
  if (is.na(nigra_gt_matrix[row,col] == TRUE )) {
    nigra_gt_matrix[row,col] = "NA"
  }
  else {
    nigra_gt_matrix[row,col] <- as.character(as.numeric(nigra_gt_matrix[row,col]) * 2)
  }
}
```


5. Transform nigra_gt_matrix back to tibble
```{r}
nigra_gt_new <- as.data.frame(nigra_gt_matrix)
dat <- nigra_gt_new %>%
  select(-Old.Name) 
dat <- as.data.frame(sapply(dat, as.numeric))
nigra_gt_n <- dat %>%
  mutate(Old.Name = nigra_gt_new[,1]) %>%
  select(Old.Name, everything())
nigra_gt_n <- tibble(nigra_gt_n)
nigra_gt_n
```

### combine genotypes and phenotypes into one bulk file ###
1. Modify each genotype marker name, prepare for distinguishing after merge the tables.
```{r}
# P.deltoides
newcolname <- c("Old.Name")
for (i in 2:ncol(deltoides_gt)) {
  newmarker <- paste(colnames(deltoides_gt)[i],"D",sep = "_")
  newcolname <- c(newcolname,newmarker)
}
deltoides.gt <- deltoides_gt
colnames(deltoides.gt) <- newcolname
head(deltoides.gt)
```

```{r}
# P.nigra
newcolname <- c("Old.Name")
for (i in 2:ncol(nigra_gt_n)) {
  newmarker <- paste(colnames(nigra_gt_n)[i],"N",sep = "_")
  newcolname <- c(newcolname,newmarker)
}
nigra.gt <- nigra_gt_n 
colnames(nigra.gt) <- newcolname
head(nigra.gt)
```

```{r}
# Dosage
newcolname <- c("Old.Name")
for (i in 2:ncol(dosage_gt)) {
  newmarker <- paste(colnames(dosage_gt)[i],"I",sep = "_")
  newcolname <- c(newcolname,newmarker)
}
dosage.gt <- dosage_gt
colnames(dosage.gt) <- newcolname
head(dosage.gt)
```


2. Combine three genotypes
```{r}
Del.Nig.Dos.geno <- deltoides.gt[,1]
for (i in 2:ncol(deltoides.gt)) {
  marker <- cbind(deltoides.gt[,i],nigra.gt[,i],dosage.gt[,i])
  Del.Nig.Dos.geno <- cbind(Del.Nig.Dos.geno, marker)
}
head(Del.Nig.Dos.geno)
```

3. add phenotypes
```{r}
leaf.Del.Nig.Dos <- left_join(Del.Nig.Dos.geno,leaf.new,by = "Old.Name")
leaf.Del.Nig.Dos
```

### create linear model ###
1. load library
```{r}
library(lmerTest)
library(lme4)
```

2. Recurrently run linear model for each marker
```{r}
summary(lmer(Blup_Transfo_Num_Indents_field_year2 ~ Chr01_126238_809425_D + Chr01_126238_809425_N + (1 | Chr01_126238_809425_I), data = leaf.Del.Nig.Dos))
```


Collect columns with unique dosage stage.
The sample level should be > 1 for random effect to succesfully run in lmer(). 
```{r}
once <- c()
for (i in 2:2890) {
  nums <- leaf.Del.Nig.Dos[,i][is.na(leaf.Del.Nig.Dos[,i]) == FALSE]
  if (length(unique(nums)) == 1) {
    once <- c(once,i)
  }
}
once <- c(once, 169,583,586,856,859,862,904,907,910,913,1321,1459,1684,1873,2068,2257,2446,2731,2734,2737)
once  
```


```{r}
for (j in 2926:length(leaf.Del.Nig.Dos)) {
  Pheno <- leaf.Del.Nig.Dos[,j]
  pheno.name <- colnames(leaf.Del.Nig.Dos)[j]
  geno <- seq(2,2890,3)
  lmer.pvalue <- tibble(Marker = c("Test"), 
                        Intercept = c(123), 
                        Deltoides = c(123), 
                        Nigra = c(123))

  for (i in geno) {
    if (((i+2) %in% once) == FALSE) {
      colnames(leaf.Del.Nig.Dos)
      Del.gt <- leaf.Del.Nig.Dos[,i]
      Nig.gt <- leaf.Del.Nig.Dos[,i+1]
      Dos.gt <- leaf.Del.Nig.Dos[,i+2]
      m <- summary(lmer(Pheno ~ Del.gt + Nig.gt + (1 | Dos.gt), data = leaf.Del.Nig.Dos))
      pvalue <- m$coefficients[,5]
      if (length(pvalue) < 3) {
        diff <- 3 - length(pvalue)
        for (j in 1:diff) {
          pvalue <- c(pvalue,"NA")
        }
      }
      P.value <- c(colnames(deltoides_gt)[(i+1)/3+1],pvalue)
      lmer.pvalue <- rbind(lmer.pvalue,P.value)
    }
  }
  lmer.pvalue <- lmer.pvalue %>% 
    filter(Marker != "Test") %>%
    mutate(Del_P_adj = p.adjust(as.numeric(Deltoides), "BH")) %>%
    mutate(Nig_P_adj = p.adjust(as.numeric(Nigra), "BH")) %>%
    mutate(CHR = as.numeric(str_replace(string = Marker, pattern = "(...)(..)_(.*)_(.*)",replacement = "\\2"))) %>%
    mutate(BP = as.numeric(str_replace(string = Marker, pattern = "(...)(..)_(.*)_(.*)", replacement = "\\3")))
  
  # save pvalue file
  write_csv(lmer.pvalue, paste("../Pvalue_Leaf_lmer/", pheno.name, ".csv", sep = ""))
  
  # Manhattan plot for four variables
  # Deltoides
  Del.man <- lmer.pvalue %>%
    select(Marker, CHR, BP, Del_P_adj) %>%
    filter(Del_P_adj != "NA")
  manhattan(Del.man, snp = "Marker", p = "Del_P_adj", suggestiveline = -log10(0.05), genomewideline =-log10(0.1), main = paste("Manhattan_lmer_Del", pheno.name, sep = "_"))
  dev.copy(png, paste("../Manhattan_Leaf_lmer/Man_lmer_Del_", pheno.name, ".png", sep = ""), width = 500, height = 300)
  dev.off()
  # Nigra
  Nig.man <- lmer.pvalue %>%
    select(Marker, CHR, BP, Nig_P_adj) %>%
    filter(Nig_P_adj != "NA")
  manhattan(Nig.man, snp = "Marker", p = "Nig_P_adj", suggestiveline = -log10(0.05), genomewideline =-log10(0.1), main = paste("Manhattan_lmer_Nig", pheno.name, sep = "_"))
  dev.copy(png, paste("../Manhattan_Leaf_lmer/Man_lmer_Nig_", pheno.name, ".png", sep = ""), width = 500, height = 300)
  dev.off()
}
```


```{r}
a <- seq(2732,2890,3)
Pheno <- leaf.Del.Nig.Dos[,2891]
for (i in a) {
    print(i)
    if (((i+2) %in% once) == FALSE) {
      colnames(leaf.Del.Nig.Dos)
      Del.gt <- leaf.Del.Nig.Dos[,i]
      Nig.gt <- leaf.Del.Nig.Dos[,i+1]
      Dos.gt <- leaf.Del.Nig.Dos[,i+2]
      m <- summary(lmer(Pheno ~ Del.gt + Nig.gt + (1 | Dos.gt), data = leaf.Del.Nig.Dos))
    }
}
```
